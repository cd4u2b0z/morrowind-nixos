#!/usr/bin/env bash
# Quick wallpaper picker using fuzzel
# Works on both Arch (~/Pictures/Wallpapers) and NixOS (~/.config/wallpapers)

# Find wallpaper directory (check both locations)
if [[ -d "${HOME}/Pictures/Wallpapers" ]]; then
    WALLPAPER_DIR="${HOME}/Pictures/Wallpapers"
elif [[ -d "${HOME}/.config/wallpapers" ]]; then
    WALLPAPER_DIR="${HOME}/.config/wallpapers"
else
    notify-send "Wallpaper" "No wallpaper directory found"
    exit 1
fi

HYPRLOCK_CONF="${HOME}/.config/hypr/hyprlock.conf"

# List wallpapers and let user pick with fuzzel (follow symlinks with -L)
SELECTED=$(find -L "$WALLPAPER_DIR" -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.webp" \) -printf '%f\n' | sort | fuzzel --dmenu -p "Wallpaper: ")

if [[ -z "$SELECTED" ]]; then
    exit 0
fi

WALLPAPER_PATH="${WALLPAPER_DIR}/${SELECTED}"

# Apply wallpaper with swww (animated transitions)
if command -v swww &>/dev/null; then
    swww img "$WALLPAPER_PATH" --transition-type grow --transition-duration 2 --transition-pos center
else
    # Fallback to hyprpaper
    hyprctl hyprpaper unload all 2>/dev/null
    hyprctl hyprpaper preload "$WALLPAPER_PATH" 2>/dev/null
    hyprctl hyprpaper wallpaper ",$WALLPAPER_PATH" 2>/dev/null
fi

# Sync hyprlock background to match wallpaper (only if writable)
if [[ -f "$HYPRLOCK_CONF" && -w "$HYPRLOCK_CONF" ]]; then
    sed -i "/^background {/,/^}/ s|^\([[:space:]]*path = \).*|\1${WALLPAPER_PATH}|" "$HYPRLOCK_CONF"
fi

notify-send "Wallpaper" "Applied: $SELECTED"
