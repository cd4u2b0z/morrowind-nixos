#!/usr/bin/env bash
# Wallpaper manager - slideshow control and status
# Usage: wallpaper-manager [next|prev|status]
# Works on both Arch (~/Pictures/Wallpapers) and NixOS (~/.config/wallpapers)

# Find wallpaper directory (check both locations)
if [[ -d "${HOME}/Pictures/Wallpapers" ]]; then
    WALLPAPER_DIR="${HOME}/Pictures/Wallpapers"
elif [[ -d "${HOME}/.config/wallpapers" ]]; then
    WALLPAPER_DIR="${HOME}/.config/wallpapers"
else
    notify-send "Wallpaper" "No wallpaper directory found"
    exit 1
fi

STATE_FILE="${HOME}/.cache/wallpaper-state"

# Get list of wallpapers (follow symlinks with -L)
get_wallpapers() {
    find -L "$WALLPAPER_DIR" -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.webp" \) | sort
}

# Get current wallpaper index
get_current_index() {
    if [[ -f "$STATE_FILE" ]]; then
        cat "$STATE_FILE"
    else
        echo 0
    fi
}

# Sync hyprlock background via symlink
# (hyprlock.conf is read-only on NixOS, so we point a symlink instead)
sync_hyprlock() {
    local wallpaper_path="$1"
    ln -sf "$wallpaper_path" "$HOME/.cache/current-wallpaper"
}

# Apply wallpaper by index
apply_wallpaper() {
    local index=$1
    local wallpapers=($(get_wallpapers))
    local count=${#wallpapers[@]}
    
    if [[ $count -eq 0 ]]; then
        notify-send "Wallpaper" "No wallpapers found in $WALLPAPER_DIR"
        return 1
    fi
    
    # Wrap around
    index=$((index % count))
    if [[ $index -lt 0 ]]; then
        index=$((count + index))
    fi
    
    local wallpaper="${wallpapers[$index]}"
    
    # Apply with swww (animated transitions)
    if command -v swww &>/dev/null; then
        swww img "$wallpaper" --transition-type grow --transition-duration 2 --transition-pos center
    else
        # Fallback to hyprpaper
        hyprctl hyprpaper unload all 2>/dev/null
        hyprctl hyprpaper preload "$wallpaper" 2>/dev/null
        hyprctl hyprpaper wallpaper ",$wallpaper" 2>/dev/null
    fi
    
    # Sync hyprlock background
    sync_hyprlock "$wallpaper"
    
    # Save state
    echo "$index" > "$STATE_FILE"
    
    # Show notification
    local name=$(basename "$wallpaper")
    notify-send "Wallpaper" "Applied: $name"
}

case "$1" in
    next)
        current=$(get_current_index)
        apply_wallpaper $((current + 1))
        ;;
    prev)
        current=$(get_current_index)
        apply_wallpaper $((current - 1))
        ;;
    status)
        current=$(get_current_index)
        wallpapers=($(get_wallpapers))
        count=${#wallpapers[@]}
        if [[ $count -gt 0 ]]; then
            name=$(basename "${wallpapers[$current]}")
            echo "Wallpaper $((current + 1))/$count: $name"
        else
            echo "No wallpapers found"
        fi
        ;;
    *)
        echo "Usage: wallpaper-manager [next|prev|status]"
        exit 1
        ;;
esac
